# Тестирование Telegram-бота для аукциона

Это руководство поможет вам настроить и протестировать Telegram-бота для аукционного сайта Roll to Help в среде разработки.

## Подготовка среды

1. Убедитесь, что у вас есть токен бота, полученный от [BotFather](https://t.me/botfather)
2. Убедитесь, что в файле `.env.local` заданы следующие переменные:
   ```
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   NEXT_PUBLIC_APP_URL=http://localhost:3000
   TELEGRAM_WEBHOOK_SECRET=your_webhook_secret  # Может быть любой строкой в режиме разработки
   ```

## Запуск бота в режиме разработки

В режиме разработки бот использует webhook, который требует публичного URL. Мы рекомендуем использовать [ngrok](https://ngrok.com/) для пробрасывания локального порта.

### Использование ngrok

1. Установите ngrok со страницы [ngrok.com](https://ngrok.com/download)
2. Запустите ваше приложение Next.js:
   ```
   npm run dev
   ```
3. В другом терминале запустите ngrok:
   ```
   ngrok http 3000
   ```
4. Скопируйте URL из ngrok (например, `https://abcd1234.ngrok.io`)
5. Обновите переменную в `.env.local`:
   ```
   NEXT_PUBLIC_APP_URL=https://abcd1234.ngrok.io
   ```
6. Установите webhook бота:
   ```
   npm run bot:webhook set
   ```

### Проверка статуса webhook

Чтобы проверить, правильно ли настроен webhook:

```
npm run bot:webhook check
```

## Тестирование функциональности

### Основные команды

Бот поддерживает следующие команды:

- `/start` - Приветственное сообщение
- `/help` - Список доступных команд
- `/register` - Инструкции по привязке аккаунта
- `/myauctions` - Информация о ваших аукционах (в разработке)

### Привязка аккаунта Telegram

1. Откройте сайт по адресу из `NEXT_PUBLIC_APP_URL`
2. Нажмите "Войти/Привязать аккаунт"
3. Получите код верификации
4. Отправьте код боту
5. Дождитесь подтверждения

### Тестирование уведомлений о выигрыше

Мы создали специальный скрипт для тестирования уведомлений победителям без необходимости дожидаться окончания настоящих аукционов.

Для использования:

1. Сначала привяжите аккаунт Telegram, используя инструкции выше
2. Узнайте ваш Telegram ID (можно использовать @userinfobot)
3. Запустите скрипт тестирования:

```
npm run test:notification YOUR_TELEGRAM_ID
```

Это отправит тестовое уведомление о выигрыше для тестовой игры.

#### Тестирование с реальными играми

Чтобы протестировать уведомление с реальными играми из базы данных:

```
npm run test:notification YOUR_TELEGRAM_ID GAME_ID1 GAME_ID2
```

### Тестирование полного рабочего процесса аукциона

Для тестирования всего процесса обнаружения завершенных аукционов, расчета победителей и отправки уведомлений, мы создали комплексный тестовый скрипт. Этот скрипт:

1. Создает тестовую игру с датой окончания в недавнем прошлом
2. Создает тестовую ставку для указанного пользователя
3. Запускает полный процесс обработки завершенных аукционов (включая расчет победителей и установку флага `isWinning`)
4. Отправляет уведомления найденным победителям

Для использования:

```
npm run test:workflow YOUR_TELEGRAM_ID
```

Дополнительные опции:

- `--skip-cleanup` - не удалять тестовые данные после завершения
- `--only-process` - только запустить процесс обработки, используя уже существующие в базе данных завершенные аукционы (не создает тестовую игру/ставку)

Примеры:
```
# Создать тестовую игру, ставку, обработать и отправить уведомление
npm run test:workflow 123456789

# Создать тестовую игру/ставку, обработать, но сохранить данные для проверки
npm run test:workflow 123456789 --skip-cleanup

# Только запустить процесс обработки для существующих в БД завершенных аукционов
npm run test:workflow --only-process
```

Этот тест наиболее точно имитирует реальный рабочий процесс, который будет выполняться по расписанию.

### Примечание о работе с системным временем

Если ваше системное время установлено некорректно, используйте опцию `--force-direct` для тестирования отправки уведомлений. Эта опция обходит проверку времени завершения аукциона и напрямую отправляет тестовое уведомление.

## Устранение неполадок

### Бот не отвечает

1. Проверьте, что токен бота правильный
2. Убедитесь, что webhook установлен: `npm run bot:webhook check`
3. Проверьте логи Next.js на ошибки
4. Убедитесь, что ваш ngrok URL доступен извне

### Ошибки в уведомлениях

Если у вас возникают проблемы с тестированием уведомлений:

1. Проверьте, что пользователь с указанным Telegram ID существует в базе данных
2. Убедитесь, что формат вашего Telegram ID правильный (это строковое представление числа)
3. Проверьте консоль на наличие ошибок во время выполнения тестового скрипта

## Запуск в производственной среде

В производственной среде бот настраивается автоматически при запуске сервера. См. `DEPLOYMENT.md` для более подробной информации. 